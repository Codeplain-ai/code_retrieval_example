# Command-Line Code Retrieval Tool

***Definitions:***

- :CodeBase: is a collection of source files stored in a directory structure.
  - :CodeBase: can include multiple programming languages (.py, .js, .java, etc.).
  - :CodeBase: may include nested directories and submodules.
  - Only files matching specified extensions are considered for indexing.

- :Chunk: represents a logical portion of code extracted from :CodeBase:.
  - A :Chunk: can correspond to:
    - A function or method
    - A class
    - A block of code (e.g., grouped lines)
  - Each :Chunk: has the following metadata:
    - Filename – source file path
    - Line Range – starting and ending line numbers
    - Function/Class Name – if applicable
    - :Chunk: Text – code snippet for display

- :Embedding: is a vector representation of a :Chunk: used for semantic similarity search.
  - :Embedding: instances are generated using a pre-trained model code embedding model.
  - Each :Embedding: is associated with its corresponding :Chunk: metadata.

- :Index: is a vector database storing :Embedding: instances and their associated metadata.
  - Supports fast similarity search using FAISS.
  - :Index: is persistent and can be saved to disk.
  - Supports incremental updates when files in :CodeBase: are added, modified, or deleted.

- :Query: represents a user-provided natural language search string.
  - :Query: is converted into an :Embedding: using the same model as the code :Chunk: instances.
  - The :Query: :Embedding: is compared with indexed :Embedding: instances to retrieve top-k similar :Chunk: instances.

- :CodeRetrievalTool: is a CLI application that can extract :Embedding: instances from the :CodeBase: files, save them to an :Index: and then search the :Index: using a natural language :Query:.

- :User: is a human interacting with the :CodeRetrievalTool:.

- :CLI: (Command-Line Interface) is the interface through which :User: interacts with the :CodeRetrievalTool:.
  - Accepts search queries and optional parameters such as:
    - `--top-k` – number of results to return
    - `--extensions` – filter by file extensions
    - `--folder-path` – restrict search to specific directories

***Non-Functional Requirements:***

- :CodeRetrievalTool: must be written in Python 3.11+.

- The following external libraries must be used:
  - `sentence-transformers` for embedding generation.
  - `faiss` for vector indexing and similarity search.
  - `click` for command-line interface handling.
  - `pytest` for automated testing.

- :Index: must be stored persistently on disk and loadable for repeated searches without regeneration.

- Incremental updates must efficiently update :Index: without rebuilding from scratch.

- File operations must handle large codebases gracefully, avoiding excessive memory consumption.

- :Embedding: instances and :Index: must be stored in a format that supports metadata retrieval alongside vectors.

- [ModelUse](./jina_model_use.md) reference file describes the implementation of the Jina Embedding model in then sentence-transformers and transformers libraries. It also describes an example of chunking.

- For testing, the jina-embeddings-v2-small-en model should be used.

- The model should be usable on a CPU.

***Test Requirements:***

- The Conformance Tests will be run using the `python -m unittest discover` call.

- Conformance Tests that include loading of :Index: and the model might take a long time so they should not be limited by short timeouts during testing. A model can take up to 2 minutes to load if it has not been downloaded beforehand.

- The :CLI: executable file will be in the current working directory when testing.

## File parsing

***Non-Functional Requirements:***

- The code should be implemented in the file_parsing folder.

***Functional Requirements:***

- Implement a functionality to extract :Chunk:s from a given file.
  - Take a file path as input.
  - Extract :Chunk:s from the file with accurate metadata (filename, line range, function/class name, chunk text).
  - The chunking strategy should be heuristic line-based chunking where the code is split into chunks of 50 lines.
  - Return the extracted :Chunk:s and their respective metadata.

- Implement a function that takes a folder path and a list of file extensions as input and extracts :Chunk:s from each file.
  - Should only extract :Chunk:s from files that match extensions from the input extensions list.
  - Returns a list of :Chunk:s composed of :Chunk:s extracted from all files.

## Embeddings

***Non-Functional Requirements:***

- The code should be implemented in the embeddings folder.

***Functional Requirements:***

- Implement an CodeEmbedding class that implements the :Embedding:
  - The class should contain an __init__ function that initializes the embedding model using the SentenceTransformers library.
  - The model name should be taken as an optional input and be "jinaai/jina-code-embeddings-0.5b" by default.

- Extend the functionality of the CodeEmbedding class with an extract_embeddings function that takes as input a :Chunk: or string and extracts the embeddings from the :Chunk: text or input string using the embedding model.
  - The function should return the extracted embedding of the input :Chunk: or and input string.

- Implement the process_chunks function in the CodeEmbeddingClass that takes a list of :Chunk: instances, extracts :Embedding: instances from each of them and associates the resulting :Embedding: with the :Chunk:.

## Index

***Non-Functional Requirements:***

- :Index: should be implemented in the data_index folder

- :Index: should be implemented with functions from the faiss library

***Functional Requirements:***

- Create the CodeIndex class that implements the :Index: 
  - It should contain an init function that initializes the :Index: of :Embedding: instances.
  - Use the faiss library to create a FAISS :Index: object.
  - initialize the metadata as an empty list

- Implement an add function to the CodeIndex class that takes an :Embedding: and :Chunk: metadata as input and adds them to the :Index: and metadata.

- Implement functionality in the CodeIndex class to load the FAISS :Index: and metadata taking file paths as input.

- Implement a save function that writes the FAISS :Index: and metadata to their respective files.

  ***Acceptance Tests:***

  - The save function should result in a FAISS index file and a metadata file where both files should have the same number of entries and the metadata file should contain accurate metadata for every extracted Chunk.

- Implement a query_index function that takes a string as an input and returns the top K results from :Index:.
  - The embeddings module should be used to extract the :Embedding: instances from an input string to compare to the :Embedding: instances in :Index:.
  - The function should return the the top K results from :Index:.

## CLI

***Non-Functional Requirements:***

- :CLI: entry point should be defined in the code_search.py file in the base folder.

***Test Requirements:***

- Where appropriate, the Conformance Tests must test the :CLI:

- :CLI: Tests must simulate:
  - Search commands with various queries
  - Output formatting and metadata display
  - Handling of invalid or empty queries

- The :CLI: executable file will be in the current working directory when testing.

***Functional Requirements:***

- Implement the --init CLI command:
  - Take a folder path as input
  - Initializes a new CodeIndex
  - Extract :Chunk:s from files in the chosen folder using functions in the file_parsing module
  - Fails if :Index: at that folder path already exists
  - Extract :Embedding: instances from :Chunk: instances using the process_chunks function from the embeddings module
  - Adds the :Embedding: instances to :Index: using the add function of the CodeIndex class
  - Saves :Index: using the save function of the CodeIndex class.

- Implement the --query CLI command:
  - Take an :Index: file path and a :Query: text as input
  - Load :Index: using the load function of the CodeIndex class.
  - Extract the :Embedding: of the :Query: using extract_embeddings function of the embeddings module
  - Search :Index: using the search function of the CodeIndex class to obtain top-k :Chunk: instances.
  - Print out the top-k :Chunk: instances.